// Define the passage once
const section1Passage = `
<h5 style="font-weight: bold;">Guest Column: Fight Fire with Fire</h5>
By Paula Lehner, Director, Riverton Land Management Council<br><i>Riverton Daily News,</i> <br> June 4

<p>Here's an alarming number: $2 billion, the amount the U.S. Forest Service spends each year on wildfire suppression...</p>

<p>In addition to causing fuel buildup, wildfire suppression has other negative consequences...</p>

<p>Certainly, there will always be fires that we have to fight...</p>

<p>There is no way around it. We have to fight fire with fire.</p>

<hr>

<h5 style="font-weight: bold;">Letter to the Editor: Prescribed Burns</h5>
<i>Riverton Daily News</i>, <br> June 11

<p>I found Paula Lehner's opinion piece about prescribed burns nothing less than horrifying...</p>

<p>As for her ridiculous idea that "controlled" fires are needed to rid areas of wildfire fuel...</p>

<p>Finally-and this is the worst omission of all-she did not mention the costs to the surrounding area of the fires she wants to set...</p>

<p>Ms. Lehner should do more research before recommending a dangerous path for our community. We must fight the fire, not add fuel to it.<br><p>
Roy Rodriguez, resident <br> Riverton
`;
const section1Passage2 = `
 <h5 style="font-weight:bold;">The State of the Union Address</h5>
  by Adelaide Jackson, editor<br>
  for HistoryWeb.org<br>
  July 15, 2012
<br>
  <h6 style="font-weight:bold;">The U.S. Constitution and the Address</h6>
  <p>The State of the Union address is mandated by the U.S. Constitution, Article II, Section 3, Clause 1. In the address, the president must provide Congress with a status report on the conditions of America. The Constitution does not specify when or how the president should deliver the address. However, in most years the president has given the speech early in the year—just after Congress has reconvened—either in written form or in person.</p>

  <h6 style="font-weight:bold;">The Evolving Address</h6>
  <p>In 1790, President George Washington delivered the first State of the Union address in person to Congress. Washington's immediate successor, John Adams, also delivered the address in person. However, when Thomas Jefferson took office, he chose to forgo the practice. He claimed it was too much like the approach used by the government from which the United States had fought to gain its independence. Instead, Jefferson chose to put remarks to Congress in a written report.</p>

  <p>In the twentieth century, this approach changed—as did several key elements of the address. Woodrow Wilson resumed personal delivery of the speech in 1913. In 1923, Calvin Coolidge expanded the audience of the address to the nation by delivering the speech over the radio. In 1947, Harry Truman's speech was the first televised State of the Union address. George W. Bush became the first president to have his address transmitted live on the Internet in 2002 (see Figure 1).</p>

  <p>In addition to the changing delivery and audience, the name and role of the address has changed over the centuries. In the eighteenth century, the speech was known as the Annual Message. In the mid-twentieth century, the phrase "State of the Union" was coined by the thirty-second president, Franklin D. Roosevelt.</p>

  <p>In the formative years of the United States, the address was a presidential duty dictated by the founding members of the government. By the middle of the last century, though, the address had grown to an important political tool wielded by the president and criticized by the president's opponents.</p>
  
  <div style="display: flex; justify-content: center;">
  <img src="Capture.PNG" alt="Description of your image">
</div> <br>
<h5 style="font-weight-bold">The Relevance of the State of the Union Address</h5>
  by Clark Atel, contributor<br>
  for <i>Media Matters Weekly</i><br>
  August 22, 2012<br>

  <p>Over the past few decades, the percentage of Americans who watch the State of the Union address on television has declined, according to Nielsen Media Services (see Chart 1). However, this decline does not indicate that the speech is no longer relevant to the country and its operations. Instead, it points to a shift both in how the president uses the address and the manner in which the American public gains access to the president's message.</p>
<div style="display: flex; justify-content: center;">
  <img src="2.PNG" alt="Description of your image">
</div> <br>
 <p>In the eighteenth and nineteenth centuries, the State of the Union was delivered to the Congress and reported to the public in newspapers. With the inventions of radio, television, and the Internet, the American public went from recipients of day-old news to in-real-time audience members. As the demographic of the address's audience shifted, so did the tone and purpose of the address. Presidents in the twentieth century began using the tool less as a mechanism for updating the country on its status and more as a method for promoting presidential policy.</p>

  <p>According to a 2009 report by the Congressional Research Service (CRS), modern-day presidents have—successfully—used the State of the Union address to promote their policy proposals to the American public. The report cites an analysis of State of the Union addresses from 1946 to 2003. In that analysis, the correlation was made between the number of words the speaking president devoted to an issue and the percentage of the American public that identified that issue as a national priority.</p>

  <h6 style="font-weight:bold;">24-Hour News Cycles and the Internet</h6>

  <p>In the twenty-first century, information about presidential policy is constantly available via 24-hour news channels on cable television and over the Internet. This dramatic shift in information access has resulted in a decrease in the number of real-time viewers of State of the Union addresses. However, live viewing is only one way to learn what the president says. The message is available in transcripts, video posts, and excerpts—all formats in which the address is propagated over the Internet. For instance, typing "State of the Union" into a popular Internet search engine returns nearly two million possible options for Internet users to watch or read the address. Furthermore, searching a common video website shows that a video of the 2010 State of the Union address posted by the White House was viewed almost half a million times. This posting was only one of many, some of which had also been viewed hundreds of thousands of times. This evidence is indicative of the continuing relevance of the State of the Union address. Fewer Americans are watching the address via live television, but it still influences American voters and public discourse.</p>

  `;

const section2Passage = ` <h5 style="text-align:center; font-weight:bold">Excerpt From <i>A Box of Matches</i><br>by Nicholson Baker</h5>
  

  <p>Good morning, it's 4:45 a.m., and today after I made the fire I just sat for ten minutes doing nothing. Every so often I yawned, leaning forward in my chair with my elbows on my knees and my hands clasped. Sometimes a yawn will take on a life of its own, becoming larger and more extensive than I could have foretold, forcing me to bow my head and gape until several drops of saliva, fed by streams on the inside of my cheeks, collect at the corners of my mouth and fall to the floor. After a few large down-yewns like these, my eyes are lubricated and I can think more clearly. I don't know whether scientific studies of the human yawn have taken into account the way it helps to lubricate the eyeballs.</p>

  <p>I do worry about the duck in the cold. She's probably awake. We have a duck that lives in a doghouse outside. At night we drape a blanket over the doghouse and put a portable window screen over its front entrance. The screen is there to keep out foxes and coyotes. There is a red fox that lives on the hill with a bushy horizontal tail that is almost as big as he is, and at night sometimes you can hear the coyotes hooting from the fields on the other side of the river.</p>

  <p>The duck's blue dish freezes overnight. Every morning, before I leave for work (dropping Phoebe at school on the way), I hit the bowl upside down against a snow-pile and a disk of ice plops out; the bowl is self-cleaning in this weather. There are several other ice disks lying around in the snow, and these are packed at by crows in the daytime. They look like UFOs, or maybe more like corneas--the layer of half-dissolved duck food frozen at the upturned bottom is the iris. The duck emerges, making her tiny rapid cheeps, excited over the prospect of the warm water, which steams when I pour it in the bowl. She makes long scoops of water with her under-beak and then straightens her neck to let the warmith slide down. I hold out a handful of feed, and she goes at it with her beak, very fast, with much faster movements than humans can make, moving like the typing ball on an old IBM Selectric.<sup>1</sup> Some of the feed falls in the water, and that gets her crazy: she roots around in the swampy warmith, rapping at the bottom and finding all the nuggets that swirl there, making the water cloudy with the outflow from her throat. After a last burst of eating she looks up and is still, working her neck twice to settle her heartbeat, and she walks out with me down the street, and she walks out with me down the walkway. Sometimes here she will flap her wings hard, high-stepping in place without becoming airborne, like a jogger at a stoplight; sometimes she takes flight, although she hasn't completely refined her landings. Her eyes are on the sides of her head: she has to turn away from me to look up at me, then out at the world, then up at me again.</p>

  <p>Last night I was lying in bed when I heard a terribly sad sound, as of a cat in distress or an infant keening in the cold: long, slow, heart-rending cries. I half rose and held my breath and listened intently--was it the duck?—but the sound had stopped. I almost woke Claire to ask her what I should do. And then, as I resumed breathing, I realized that I was hearing a whistling coming from some minor obstruction in my own nose as I breathed.</p>

  <p> 
At times, when I sit here, a long series of daytime thoughts will pass through me—thoughts connected with work or, say, with town politics. That's all right—let those thoughts pass through you. You hear them coming, like a freight train with the whistle and the dinging; they take several minutes to go by, and then they're gone. Remember that it's very early in the morning—early, early, early, early. Sometimes the stars are thrillingly sharp when I first get up and stand at the window on the landing of the stairs: private needle-holes of exactitude in the stygian diorama.² Orion's belt is the only constellation that I recognize easily. The apportioning of stars into constellations is unnecessary: their anonymity enhances the sense of infinitude. This morning I saw a long pale mark like a scar across the heavens. It was the trail of a nigh jet, a night flight from somewhere to somewhere, lit from the underside by the setting moon. "A moonlit contrail,"³ I whispered to myself, and then I came downstairs and felt for the coffeemaker.</p>
 `;
const section3PassageTemplate = `

The passage below is incomplete. Navigate to each "Select..." button and choose the option that correctly completes the sentence <b>using formal standard English.</b>
<br>
To: The Northwest Community College Gazette Staff
<br>
From: Robert Clark, Editor in Chief
<br>
Date: February 22
<br>
Re: Campus security
<br>
I know you all are focused on producing an excellent newspaper, but allow me to direct your attention to another area that also requires your extraordinary diligence—campus security.
<br>
You should be aware that break-ins [[dropdown1]] in the general vicinity of campus. Thieves have targeted business offices and schools to steal technology hardware and resell it for a quick profit. These thieves often brazenly walk into unattended offices in broad daylight and haul away computers worth thousands of dollars. Carelessness and inattention are [[dropdown2]] accomplices. <br>
<br>
In our workplace, we have unfortunately become relaxed about security. I do not have to remind you that numerous students and nonstudents pass by our office in the student union daily, and it is no secret that any newspaper office contains valuable computers, printers, fax machines, digital cameras, and other equipment that thieves target. So please take the following precautions to protect our workplace: <br>
<br>
<ul>
  <li>[[dropdown3]] Do not forget to reset the alarm if you are the last one to leave the office. Never give the security code to anyone who is not a member of our staff.</li>

  <li>Starting next month, everyone will be issued keys to the front door and to his or her office. 

      Keep these keys on a key ring and treat them with the same vigilance you would the keys to your car or residence.
      Report any missing keys immediately.
      The fee for replacing a lost key is $50, and failure to pay the fee may inhibit your ability to enroll in classes the following semester.
      Never lend your office key to anyone, especially a nonstaffer.
    
  </li>

  <li>Try to avoid working in the office alone, but if you must, make sure to keep the front door locked.
  Do not open the door to someone unknown to you. He or she can reach a staff member or campus security by using the contact information posted outside our office.</li>
  <li>[[dropdown4]] Keep an eye out for suspicious behavior. 
    If you spot anyone loitering near the office, notice the front door ajar when no one is scheduled to be working, or detect any other irregularities, immediately call the campus police.</li>
    
  </li>
<br>
  I appreciate your cooperation in keeping our staff and workplace safe.
</ul>
`;

const erPassage = ` <h6 style="font-weight:bold;">Speech: Proposal for Automatic Traffic Light Cameras</h6>
    by Councilman Lorenzo Hart<br>
    Baler Town Council meeting<br>

    <h6>Fellow council members:</h6>

            <p>The cuts to this year's budget mean that fewer funds are available for many town departments. We must thoughtfully examine how to use our resources most effectively. I propose installing automatic traffic light cameras at 10 major intersections in town.</p>
        
            <p>Clearly, monitoring intersections is a public safety concern that lends itself to technology. Automatic traffic cameras photograph the license plates of automobiles running red lights. The town then sends traffic tickets to the violators. Automating this process will allow our police officers to focus on duties that require human attention, saving the cost of hiring additional officers.</p>
        
            <p>Beyond the practical advantage, automatic traffic cameras have well-documented benefits. The National Highway Traffic Safety Administration states that running red lights causes hundreds of traffic fatalities and thousands of injuries annually. According to a 2010 report by the Insurance Institute for Highway Safety, red-light cameras have lowered these numbers in hundreds of U.S. cities. A 2005 Federal Highway Administration study found a 25% decrease in front-into-side auto accidents in seven cities that use red-light cameras.</p>
        
            <p>Currently, drivers who get away with red-light violations tend to repeat the behavior, making intersections less safe overall. Automatic cameras discourage this habit. A 2009 study of a program in Montgomery County, Maryland, showed an average 78% decline in the number of red-light tickets issued after the cameras had operated for a year. Only about one-third of the drivers who each received a red-light violation ticket repeated the violation within a two-year period.</p>
       
            <p>In addition, by citing violators who may have gone unpunished without the assistance of the cameras, our town would increase revenue through additional traffic fines. A single intersection in Lawrence Township, New Jersey, generated over $1 million in fines in only one year. The facts show that an investment in these cameras pays for itself. Please support this proposal.</p>
    <br>
    
<b>Letter to the Editor: Automatic Cameras Not an Automatic Solution</b> <br>

Baler Herald <br>
April 8

<p> The town council's proposal to install 10 automatic red-light cameras at traffic lights is a proposal to waste money. I have scrutinized the details and calculated the costs. The proposal does say that the company AutoCamera Inc. has promised to waive installation fees that would normally run $50,000–$100,000 per intersection. However, that same company will charge us $5,000–$6,000 each month per camera to operate and maintain the cameras. That is at least $60,000 per year for one camera. Installing 10 cameras will have quite a high price tag. Six hundred thousand dollars per year could instead pay the salaries of new officers.</p>

<p> These cameras create other unexpected costs as well. In New Jersey and New York, several cities have been sued over the timing of traffic lights with automatic cameras. Plaintiffs often contend that the yellow lights are illegally short and that required inspections of the cameras were not performed. Lawsuits over automatic cameras are all too common, occurring also in states such as Ohio, Illinois, Missouri, and California. In a single December in New Jersey alone, traffic light company ATS settled 16 separate class-action lawsuits. Because we cannot control public reaction to these cameras, the real costs are hidden. Any new fines collected may pale in comparison to increased legal fees. </p>

<p> Additionally, the safety benefits of automatic red-light cameras are unclear. A 2005 National Highway Traffic Safety Administration report says that some cities using the cameras have seen a decrease in front-into-side accidents, but rear-end collisions have increased. Apparently, speeding drivers notice the cameras at the last minute. They apply their brakes abruptly, surprising the unsuspecting drivers behind them and causing accidents. These additional collisions are avoidable if we reject this proposal.</p>

<p> In every way, actual traffic police officers are superior to automatic red-light cameras. The only investment we need to make is hiring more officers.</p>
<br>
Madison Caan, civil engineer
<br> Baler   
    `;
const section3Dropdowns = {
    dropdown1: ["is occuring", "has occured", "have occurred", "has been occurring"],
    dropdown2: ["its", "our", "their", "your"],
    dropdown3: ["Memorize the four-digit code, once you have written it down for our alarm.", "For our alarm, memorize the four-digit code once you write it down.", "effOnce you write it down for our alarm, memorize the four-digit code.ort", "Once you write down the four-digit code for our alarm, memorize it."],
    dropdown4: ["Above all,", "For example,", "On the other hand,", "In the interest of time,"]
};

const questions = [
    // Section 1
    {
        passage: section1Passage,
        type: "mcq",
        question: "Which quotation supports patience? (Q1)",
        options: ["A. 3", "B. 4", "C. 5", "D. 22"],
        answer: "B",
        section: 1
    },
    {
        passage: section1Passage2,
        type: "mcq",
        question: "Which quotation supports patience? (Q1)",
        options: ["A. 3", "B. 4", "C. 5", "D. 22"],
        answer: "B",
        section: 1
    },
    {
        passage: section1Passage,
        type: "drag-drop",
        question: "Drag each animal into the correct habitat:",
        options: [
            { id: "lion", text: "Lion" },
            { id: "penguin", text: "Penguin" },
            { id: "camel", text: "Camel" }
        ],
        correctPlacement: {
            "Savanna": ["lion"],
            "Antarctica": ["penguin"],
            "Desert": ["camel"]
        },
        section: 1
    },


    // Section 2
    {
        passage: erPassage,
        type: "er", // extended response
        question: "Write your response to the passage here:",
        answer: "", // no predefined answer for ER
        section: 2
    },

    // Section 3 - Normal Fill Question
    {
        passage: section2Passage,
        type: "mcq",
        question: "Which quotation supports patience? (Q1)",
        options: ["A. 3", "B. 4", "C. 5", "D. 22"],
        answer: "B",
        section: 3
    },

    // Section 3 - Dropdown Question (Email)
    {
        passage: section3PassageTemplate,  // use the template defined above
        type: "dropdown",                  // mark as dropdown type
        question: "Complete the email using the dropdowns below:", // the question prompt
        options: section3Dropdowns,        // use the dropdown options object
        section: 3
    },


];

let currentQuestionIndex = 0;
const answers = [];
const totalQuestions = questions.length;

// Sections
const sections = [
    { name: "Section 1", duration: 27 }, // minutes
    { name: "Section 2", duration: 45 },
    { name: "Section 3", duration: 65 }
];
let currentSectionIndex = 0;
let sectionDuration = sections[currentSectionIndex].duration * 60; // in seconds
const timerDiv = document.getElementById("timer");
let timerInterval;

// Show Section Complete Modal
function showSectionComplete(sectionName, isTimeUp = false) {
    const modal = document.getElementById("section-modal");

    if (currentSectionIndex === sections.length - 1) {
        // Last section
        document.getElementById("modal-title").textContent = isTimeUp
            ? `⏰ Time's Up!`
            : `All Sections Completed!`;
        document.getElementById("modal-msg").textContent = isTimeUp
            ? `${sectionName} time is over. Click below to finish the exam.`
            : `Click below to finish the exam.`;

        document.getElementById("modal-next-btn").textContent = "Finish Exam";
        document.getElementById("modal-next-btn").onclick = () => {
            modal.style.display = "none";
            submitExam(); // Show results
            passageDiv.style.display = "none"; // hide passage
            qDiv.style.display = "none"; // hide questions
            nextBtn.style.display = "none";
            backBtn.style.display = "none";
            timerDiv.style.display = "none";
        };
    } else {
        // Not last section
        document.getElementById("modal-title").textContent = isTimeUp
            ? `⏰ Time's Up!`
            : `${sectionName} Completed!`;
        document.getElementById("modal-msg").textContent = isTimeUp
            ? `${sectionName} time is over. Click below to proceed to the next section.`
            : `You can now proceed to the next section.`;

        document.getElementById("modal-next-btn").textContent = "Next Section";
        document.getElementById("modal-next-btn").onclick = () => {
            modal.style.display = "none";
            currentSectionIndex++;
            sectionDuration = sections[currentSectionIndex].duration * 60;
            currentQuestionIndex = 0;
            startSectionTimer();
            renderQuestion(currentQuestionIndex);
        };
    }

    modal.style.display = "block";
}


// Section Timer
function startSectionTimer() {
    // Clear any existing timer first
    if (timerInterval) clearInterval(timerInterval);

    timerDiv.textContent = `${sections[currentSectionIndex].name} - Time left: --:--`;

    timerInterval = setInterval(() => {
        let minutes = Math.floor(sectionDuration / 60);
        let seconds = sectionDuration % 60;

        timerDiv.textContent = `${sections[currentSectionIndex].name} - Time left: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        sectionDuration--;

        if (sectionDuration < 0) {
            clearInterval(timerInterval); // Stop this interval immediately
            showSectionComplete(sections[currentSectionIndex].name, true); // Time's up modal

            currentSectionIndex++;
            if (currentSectionIndex < sections.length) {
                sectionDuration = sections[currentSectionIndex].duration * 60;
                currentQuestionIndex = 0;
                startSectionTimer();  // Start next section timer
                renderQuestion(currentQuestionIndex);
            } else {
                submitExam(); // Exam ends
            }
        }
    }, 1000);
}

// Drag & Drop functions
function allowDrop(ev) { ev.preventDefault(); }
function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
function drop(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const item = document.getElementById(data);
    ev.target.appendChild(item);
}

// Render question
// Render question
function renderQuestion(index) {
    const sectionQuestions = questions
        .filter(q => q.section === currentSectionIndex + 1)
        .map(q => ({ ...q, globalIndex: questions.indexOf(q) }));
    const q = sectionQuestions[index];

    const passageDiv = document.getElementById("passage-container");
    const qDiv = document.getElementById("questions-container");

    // Reset display defaults
    qDiv.style.display = "block";
    passageDiv.style.flex = "2"; // default

    document.getElementById("question-number").textContent =
        `Question: ${index + 1} of ${questions.filter(q => q.section === currentSectionIndex + 1).length}`;

    // === Special rendering for Section 3 dropdown email ===
    if (
        q.section === 3 &&
        q.type === "dropdown" &&
        typeof q.options === "object" &&
        !Array.isArray(q.options)
    ) {
        passageDiv.style.flex = "1";       // passage takes full width
        qDiv.style.display = "none";       // hide questions container

        let passageHTML = q.passage;
        for (let key in q.options) {
            const options = q.options[key]
                .map(opt => `<option value="${opt}">${opt}</option>`)
                .join("");
            const selectHTML = `<select name="${key}"><option value="">--Select--</option>${options}</select>`;
            passageHTML = passageHTML.replace(`[[${key}]]`, selectHTML);
        }
        passageDiv.innerHTML = passageHTML;

        const nextBtn = document.getElementById("next-btn");
        nextBtn.textContent = "Submit Section";
        nextBtn.onclick = () => {
            document.querySelectorAll("#passage-container select").forEach(sel => {
                answers[sel.name] = sel.value;
            });
            showSectionComplete(sections[currentSectionIndex].name);
        };

        const backBtn = document.getElementById("back-btn");
        backBtn.disabled = false;
        backBtn.onclick = () => {
            currentQuestionIndex = index - 1 >= 0 ? index - 1 : 0;
            renderQuestion(currentQuestionIndex);
        };

        return; // Skip normal rendering for this special dropdown
    }

    // ===== Normal question rendering =====
    passageDiv.innerHTML = q.passage ? q.passage : "";
    qDiv.innerHTML = `<div class="question"><p>${index + 1}. ${q.question}</p></div>`;
    const questionContainer = qDiv.querySelector(".question");

    if (q.type === "mcq") {
        q.options.forEach(opt => {
            const letter = opt.split(".")[0]; // "A", "B", etc.
            const optionDiv = document.createElement("div");
            optionDiv.innerHTML =
                `<input type="radio" name="q${q.globalIndex}" value="${letter}" ${answers[q.globalIndex] === letter ? "checked" : ""}> ${opt}`;
            questionContainer.appendChild(optionDiv);
        });
    } else if (q.type === "fill") {
        const input = document.createElement("input");
        input.type = "text";
        input.name = `q${q.globalIndex}`;
        input.placeholder = "Type your answer here";
        if (answers[q.globalIndex]) input.value = answers[q.globalIndex];
        questionContainer.appendChild(input);
    } else if (q.type === "dropdown") {
        const select = document.createElement("select");
        select.name = `q${q.globalIndex}`;
        q.options.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt;
            option.textContent = opt;
            select.appendChild(option);
        });
        if (answers[q.globalIndex]) select.value = answers[q.globalIndex];
        questionContainer.appendChild(select);
    } else if (q.type === "er") {
        const textarea = document.createElement("textarea");
        textarea.name = `q${q.globalIndex}`;
        textarea.placeholder = "Type your response here...";
        textarea.rows = 22;
        textarea.style.width = "100%";
        textarea.style.padding = "8px";
        textarea.style.fontSize = "14px";
        textarea.style.resize = "vertical";
        if (answers[q.globalIndex]) textarea.value = answers[q.globalIndex];
        questionContainer.appendChild(textarea);
    }
    // === NEW: drag-drop rendering ===
    else if (q.type === "drag-drop") {
        const container = document.createElement("div");
        container.className = "drag-drop-container";

        const optionsDiv = document.createElement("div");
        optionsDiv.className = "drag-options";
        q.options.forEach(opt => {
            const item = document.createElement("div");
            item.className = "drag-item";
            item.id = opt.id;
            item.draggable = true;
            item.ondragstart = drag;
            item.textContent = opt.text;
            optionsDiv.appendChild(item);
        });
        container.appendChild(optionsDiv);

        const tableDiv = document.createElement("div");
        tableDiv.className = "table-container";

        tableDiv.innerHTML = `
            <table>
                <thead>
                    <tr><th>Savanna</th><th>Antarctica</th><th>Desert</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="Savanna" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
                        <td id="Antarctica" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
                        <td id="Desert" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)"></td>
                    </tr>
                </tbody>
            </table>`;
        container.appendChild(tableDiv);
        questionContainer.appendChild(container);
    }

    // === Next button logic ===
    const nextBtn = document.getElementById("next-btn");
    nextBtn.textContent = index === sectionQuestions.length - 1 ? "Submit Section" : "Next";
    nextBtn.onclick = () => {
        saveAnswer(index, sectionQuestions);

        if (index < sectionQuestions.length - 1) {
            // If not last question in section, go next
            renderQuestion(index + 1);
        } else if (currentSectionIndex < sections.length - 1) {
            // If last question of this section, but not last section, show modal
            showSectionComplete(sections[currentSectionIndex].name);
        } else {
            // Last question of last section -> submit exam and show results
            submitExam(); // this will display results div
            passageDiv.style.display = "none"; // hide passage
            qDiv.style.display = "none"; // hide questions
            nextBtn.style.display = "none"; // hide next button
            backBtn.style.display = "none"; // hide back button
            timerDiv.style.display = "none"; // hide timer
        }
    };


    // === Back button logic ===
    const backBtn = document.getElementById("back-btn");
    backBtn.disabled = index === 0;
    backBtn.onclick = () => {
        if (index > 0) {
            saveAnswer(index, sectionQuestions);
            renderQuestion(index - 1);
        }
    };
}

// Save answer
function saveAnswer(index, sectionQuestions) {
    const q = sectionQuestions[index];

    if (q.type === "drag-drop") {
        const placements = {};
        Object.keys(q.correctPlacement).forEach(zoneId => {
            const zone = document.getElementById(zoneId);
            placements[zoneId] = Array.from(zone.children).map(e => e.id);
        });
        answers[q.globalIndex] = placements;
    }
    else if (q.type === "mcq") {
        const selected = document.querySelector(`input[name="q${q.globalIndex}"]:checked`);
        if (selected) {
            answers[q.globalIndex] = selected.value;
        }
    }
    else if (q.type === "er" || q.type === "fill") {
        const input = document.querySelector(`[name="q${q.globalIndex}"]`);
        if (input) {
            answers[q.globalIndex] = input.value;
        }
    }
    else if (q.type === "dropdown" && typeof q.options === "object") {
        // Special case: Section 3 dropdown email (multiple blanks)
        const dropdownAnswers = {};
        document.querySelectorAll("#passage-container select").forEach(sel => {
            dropdownAnswers[sel.name] = sel.value;
        });
        answers[q.globalIndex] = dropdownAnswers;
    }
    else if (q.type === "dropdown") {
        // Simple dropdown (single select)
        const select = document.querySelector(`[name="q${q.globalIndex}"]`);
        if (select) {
            answers[q.globalIndex] = select.value;
        }
    }
}


// Submit Exam
function submitExam() {
    if (timerInterval) clearInterval(timerInterval);
    let totalCorrect = 0;
    const mistakes = [];

    // Clear previous ER answers display
    const erContainer = document.getElementById("er-answers");
    erContainer.innerHTML = "";

    questions.forEach((q, index) => {
        const userAnswer = answers[index];

        if (q.type === "mcq" || q.type === "fill" || q.type === "dropdown") {
            if (userAnswer && userAnswer.toString().trim().toLowerCase() === q.answer.toString().trim().toLowerCase()) {
                totalCorrect++;
            } else {
                mistakes.push({
                    question: q.question,
                    yourAnswer: userAnswer || "No answer",
                    correctAnswer: q.answer
                });
            }
        }
        else if (q.type === "drag-drop") {
            let correct = true;

            if (q.correctPlacement) {
                for (let dropZoneId in q.correctPlacement) {
                    const expectedIds = q.correctPlacement[dropZoneId];
                    const placedIds = userAnswer?.[dropZoneId] || [];
                    expectedIds.forEach(id => {
                        if (!placedIds.includes(id)) correct = false;
                    });
                }
            }
            if (correct) {
                totalCorrect++;
            } else {
                mistakes.push({
                    question: q.question,
                    yourAnswer: JSON.stringify(userAnswer),
                    correctAnswer: JSON.stringify(q.correctPlacement)
                });
            }
        }
        else if (q.type === "er") {
            const erDiv = document.createElement("div");
            erDiv.innerHTML = `<strong>Question:</strong> ${q.question}<br>
                               <strong>Your Response:</strong> ${userAnswer || "No answer"}<hr>`;
            erContainer.appendChild(erDiv);
        }
    });

    // Score out of 200, minimum 100, maximum 200
    const minScore = 100;
    const maxScore = 200;
    const gedScore = Math.round(minScore + (totalCorrect / questions.length) * (maxScore - minScore));

    // ====== NEW RESULT UI ======
    document.getElementById("ged-score").textContent = gedScore;
    document.getElementById("correct").textContent = totalCorrect;
    document.getElementById("incorrect").textContent = questions.length - totalCorrect;
    document.getElementById("final-score").textContent = gedScore + "/200";

    // Example time (replace with real timer if you track start time)
    document.getElementById("time-taken").textContent = "00:18 / 01:10:00";

    // Status text
    const statusText = document.getElementById("status-text");
    if (gedScore >= 145) {
        statusText.textContent = "Likely to Pass ✅";
        statusText.style.color = "green";
    } else {
        statusText.textContent = "Not Likely to Pass ❌";
        statusText.style.color = "red";
    }

    // Progress bar
    const percent = ((gedScore - 100) / (200 - 100)) * 100;
    const bar = document.getElementById("score-bar");
    bar.style.width = percent + "%";
    bar.style.background = gedScore >= 145 ? "green" : (gedScore >= 134 ? "orange" : "red");

    // Show mistakes if any
    window.examMistakes = mistakes;
    document.getElementById("show-mistakes-btn").style.display = mistakes.length > 0 ? "inline-block" : "none";

    // Show result block
    document.getElementById("result").style.display = "block";
}


// Show Mistakes
function showMistakes() {
    const mistakesList = document.getElementById("mistakes-list");
    mistakesList.innerHTML = "";
    if (window.examMistakes && window.examMistakes.length > 0) {
        window.examMistakes.forEach(m => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>Q:</strong> ${m.question}<br><strong>Your Answer:</strong> ${m.yourAnswer}<br><strong>Correct Answer:</strong> ${m.correctAnswer}`;
            mistakesList.appendChild(li);
        });
        document.getElementById("mistakes").style.display = "block";
    } else mistakesList.innerHTML = "<li>No mistakes!</li>";
}

// Initialize
renderQuestion(currentQuestionIndex);
startSectionTimer();

//highlights    
document.getElementById('highlight-btn').addEventListener('click', function () {
    const passageContainer = document.getElementById('passage-container');
    let selection = window.getSelection();

    if (!selection.rangeCount) return;

    let range = selection.getRangeAt(0);

    // Only operate if selection is inside passage container
    if (!passageContainer.contains(range.commonAncestorContainer)) return;

    // Check if selection is already inside a mark
    let ancestor = range.commonAncestorContainer;
    while (ancestor && ancestor !== passageContainer) {
        if (ancestor.nodeName === 'MARK') {
            // Unhighlight: replace <mark> with its content
            let parent = ancestor.parentNode;
            while (ancestor.firstChild) {
                parent.insertBefore(ancestor.firstChild, ancestor);
            }
            parent.removeChild(ancestor);
            selection.removeAllRanges();
            return;
        }
        ancestor = ancestor.parentNode;
    }

    // Highlight: wrap selection in <mark>
    let mark = document.createElement('mark');
    mark.appendChild(range.extractContents());
    range.insertNode(mark);

    // Clear selection
    selection.removeAllRanges();
});

const passageDiv = document.getElementById("passage-container");
const qDiv = document.getElementById("questions-container");

// Reset flex by default
passageDiv.style.flex = "2";
qDiv.style.flex = "1";

// For Section 2 (ER), make passage wider
if (q.section === 2) {
    passageDiv.style.flex = "1";  // passage takes more space
    qDiv.style.flex = "2";        // questions take less space
}
function saveSection3Answers() {
    const selects = document.querySelectorAll("#passage-container select");
    selects.forEach(sel => {
        answers[sel.name] = sel.value;
    });
    // Display ER answers
    const erContainer = document.getElementById("er-answers");
    erContainer.innerHTML = ""; // clear previous content
    questions.forEach((q, index) => {
        if (q.type === "er") {
            const userAnswer = answers[index] || "No answer";
            const erDiv = document.createElement("div");
            erDiv.innerHTML = `<strong>Question:</strong> ${q.question}<br>
                           <strong>Your Response:</strong> ${userAnswer}<hr>`;
            erContainer.appendChild(erDiv);
        }
    });


}
// On drop event
function handleDrop(e, zoneId, questionIndex) {
    e.preventDefault();
    const itemId = e.dataTransfer.getData("text");
    const item = document.getElementById(itemId);
    const dropZone = document.getElementById(`drop-${zoneId}`);

    dropZone.appendChild(item);

    // Save dropped items in answers object
    if (!answers[questionIndex]) answers[questionIndex] = {};
    if (!answers[questionIndex][zoneId]) answers[questionIndex][zoneId] = [];

    if (!answers[questionIndex][zoneId].includes(itemId)) {
        answers[questionIndex][zoneId].push(itemId);
    }
}

